<!DOCTYPE html>
<html><head><title>Learn markdown-it</title><base href="https://aaronmyatt.github.io/learn-markdownit/"><link rel="stylesheet" href="styles.css"></head><body><div class="relative isolate z-10 shadow"><div class="bg-white py-5"><div class="mx-auto max-w-7xl px-6 lg:px-8"><div class="dropdown"><div class="btn m-1" tabindex="0" role="button"> Learn more<svg class="h-5 w-5" viewbox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg></div><ul class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-10" tabindex="0"><li><a href="https://aaronmyatt.github.io/learn-markdownit//">index</a></li><li><a href="https://aaronmyatt.github.io/learn-markdownit//plugins/">plugins</a></li><li><a href="https://aaronmyatt.github.io/learn-markdownit//regexPluginResearch/">pluginResearch</a></li><li><a href="https://aaronmyatt.github.io/learn-markdownit//wikilinkPlugin/">wikilinkPlugin</a></li></ul></div></div></div></div><div class="container space-y-10 my-10 flex flex-col items-center mx-auto"><div class="flex gap-4"><button class="block btn btn-lg btn-wide btn-primary" type="button" onclick="presentJSON()">Run Pipedown</button><div class="drawer drawer-end hidden" id="htmldrawer"><input class="drawer-toggle" id="my-drawer-4" type="checkbox"><div class="drawer-content"><label class="drawer-button btn btn-primary btn-lg btn-wide" for="my-drawer-4">Render HTML</label></div><div class="drawer-side z-20"><label class="drawer-overlay" for="my-drawer-4" aria-label="close sidebar"></label><div class="p-4 min-h-full bg-base-200 text-base-content space-y-6 w-11/12 md:w-1/2" id="htmldrawerbody"></div></div></div></div><div class="prose prose-2xl"><blockquote>
<p>This wont work in the browser sadly, it relies on <a href="https://deno.land/api@v1.44.2?unstable=true&amp;s=Deno.lstat">Deno's filesystem</a> API.</p>
</blockquote>
<h1>Wikilink Plugin research</h1>
<p>So there's a <a href="https://github.com/rlidwka/markdown-it-regexp/blob/master/lib/index.js">9 year old markdown-it plugin</a> designed to help ease the creation of markdown-it plugins. It matches a Regex pattern and let's the plugin author replace that Regex match with their own HTML. Unfortunately, it doesn't seem to be maintained and likely isn't playing nicely with ESM/Deno/Typescript. So I'm going to try and modernise it.</p>
<p>In principle it is quite simple, pass it a regex, and it'll pass you a markdown-it token(s) with which you can inject your own HTML to render. The challenge.. how to make it with Pipedown!</p>
<pre><code class="language-ts hljs language-typescript"><span class="hljs-keyword">import</span> markdownit <span class="hljs-keyword">from</span> <span class="hljs-string">"npm:markdown-it"</span>;
<span class="hljs-keyword">import</span> { walkSync } <span class="hljs-keyword">from</span> <span class="hljs-string">"jsr:@std/fs"</span>;
<span class="hljs-keyword">import</span> { relative } <span class="hljs-keyword">from</span> <span class="hljs-string">"jsr:@std/path"</span>;
</code></pre>
<h2>start simple</h2>
<p>The goal here is to make a plugin that will match wiki link like syntax (<code>[[wikilink]]</code>) and convert it to a link that matches a file in the project.</p>
<p>Let's try following how the plugin does it and see what we get.</p>
<pre><code class="language-ts hljs language-typescript"><span class="hljs-keyword">const</span> md = <span class="hljs-title function_">markdownit</span>().<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">md, options</span>) =&gt;</span> {
    md.<span class="hljs-property">inline</span>.<span class="hljs-property">ruler</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'wikimatch'</span>, <span class="hljs-function">(<span class="hljs-params">state, silent</span>) =&gt;</span> {
        <span class="hljs-comment">// thanks copilot? ðŸ‘‡</span>
        <span class="hljs-comment">// state.src = state.src.replace(/\[\[(.*?)\]\]/g, (match, content) =&gt; {</span>
        <span class="hljs-comment">//     return `&lt;a href="/${content}"&gt;${content}&lt;/a&gt;`</span>
        <span class="hljs-comment">// })</span>

        <span class="hljs-keyword">const</span> match = <span class="hljs-regexp">/^\[\[(.*)\]\]/</span>.<span class="hljs-title function_">exec</span>(state.<span class="hljs-property">src</span>.<span class="hljs-title function_">slice</span>(state.<span class="hljs-property">pos</span>))
        <span class="hljs-keyword">if</span>(!match) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'no match'</span>,state.<span class="hljs-property">src</span>.<span class="hljs-title function_">slice</span>(state.<span class="hljs-property">pos</span>))
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// let the parser skip what we've matched</span>
        state.<span class="hljs-property">pos</span> += match[<span class="hljs-number">0</span>].<span class="hljs-property">length</span>

        <span class="hljs-keyword">if</span> (silent) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">const</span> token = state.<span class="hljs-title function_">push</span>(<span class="hljs-string">'wikimatch'</span>, <span class="hljs-string">''</span>, <span class="hljs-number">0</span>)
        token.<span class="hljs-property">meta</span> = {match}
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    })
    md.<span class="hljs-property">renderer</span>.<span class="hljs-property">rules</span>.<span class="hljs-property">wikimatch</span> = <span class="hljs-function">(<span class="hljs-params">tokens, idx</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-attr">firstFile</span>: <span class="hljs-title class_">FileInfo</span> | <span class="hljs-literal">undefined</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> <span class="hljs-title function_">walkSync</span>(<span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">cwd</span>(), { <span class="hljs-attr">skip</span>: [<span class="hljs-regexp">/\.pd/</span>, <span class="hljs-regexp">/_site/</span>]})) {
                <span class="hljs-keyword">if</span> (file.<span class="hljs-property">path</span>.<span class="hljs-title function_">includes</span>(tokens[idx].<span class="hljs-property">meta</span>.<span class="hljs-property">match</span>[<span class="hljs-number">1</span>])) {
                    firstFile = file;
                    <span class="hljs-keyword">break</span>;
                }
            }
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-comment">// wont work in the browser</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e)
        }

        <span class="hljs-keyword">const</span> path = firstFile ? <span class="hljs-title function_">relative</span>(<span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">cwd</span>(), firstFile.<span class="hljs-property">path</span>) : tokens[idx].<span class="hljs-property">meta</span>.<span class="hljs-property">match</span>[<span class="hljs-number">1</span>];

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({firstFile})
        <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;a href="/<span class="hljs-subst">${path}</span>"&gt;<span class="hljs-subst">${path}</span>&lt;/a&gt;`</span>
    }
})

$p.<span class="hljs-title function_">set</span>(input, <span class="hljs-string">'/markdown.dirtyInlinePlugin'</span>, md.<span class="hljs-title function_">render</span>(<span class="hljs-string">`# hello

how about now

[wat](/wat)

[[evalPipedown]]`</span>))
</code></pre>
</div></div><script type="importmap">{
  "imports": {
    "/": "https://aaronmyatt.github.io/learn-markdownit/",
    "./": "https://aaronmyatt.github.io/learn-markdownit/",
    "evalPipedown": "./pd/scripts/evalPipedown/index.esm.js",
    "presentOutput": "./pd/scripts/presentOutput/index.esm.js",
    "presentMarkdown": "./pd/scripts/presentMarkdown/index.esm.js"
  }
}</script><script type="module">import presentOutput from "presentOutput";
import presentMarkdown from "presentMarkdown";
window.presentJSON = () => presentOutput.process().then(() => presentMarkdown.process());

presentMarkdown.process();</script></body></html>